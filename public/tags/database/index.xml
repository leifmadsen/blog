<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Database on Asterisk, and other worldly endeavours</title>
    <link>http://blog.leifmadsen.com/tags/database/</link>
    <description>Recent content in Database on Asterisk, and other worldly endeavours</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Tue, 08 Sep 2009 13:12:20 +0000</lastBuildDate>
    <atom:link href="http://blog.leifmadsen.com/tags/database/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Ask the Expert!</title>
      <link>http://blog.leifmadsen.com/blog/2009/09/08/ask-the-expert/</link>
      <pubDate>Tue, 08 Sep 2009 13:12:20 +0000</pubDate>
      
      <guid>http://blog.leifmadsen.com/blog/2009/09/08/ask-the-expert/</guid>
      <description>&lt;p&gt;_UPDATE (October 7, 2009):&lt;/p&gt;

&lt;p&gt;This post didn&amp;rsquo;t quite generate the type of questions I was hoping for, and because of that I&amp;rsquo;m not able to generate a knowledgeable and informed response that would be overtly useful. However, I will leave this topic open for the next little while in the hopes some more questions can be generated. It is entirely possible I haven&amp;rsquo;t been specific enough in my request for the type of questions I&amp;rsquo;d like to answer, so here goes.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;m looking for questions related to Asterisk implementation issues, specifically related to problems in the dialplan or /etc/asterisk configuration. For example, a good question might be proposed as;&lt;/p&gt;

&lt;p&gt;&amp;ldquo;I have a call center solution I&amp;rsquo;m building, and I&amp;rsquo;ve been unable to get the member status to be consistently accurate. Here are the relevant parts of my configuration currently, and the console output of my mostly correct but inaccurate status. Thanks!&amp;rdquo;&lt;/p&gt;

&lt;p&gt;Hopefully this helps to clear up any confusion I may have generated by the generally asked topic of Ask the Expert, and will lead to better questions and a fruitful article in the future. Thanks!
_&lt;/p&gt;

&lt;p&gt;I figured that due to my limited time to write blog posts, and my intent to try and write at least one blog post a week, I&amp;rsquo;d do a simple &amp;ldquo;Ask the Expert&amp;rdquo; type of article. I&amp;rsquo;ll take 5 of your questions and answer them in a blog post later this week (hopefully on Thursday). So if you have some particular problem you&amp;rsquo;re trying to get solved, or have a question about implementation, now would be a a great time to get the answer you&amp;rsquo;re looking for.&lt;/p&gt;

&lt;p&gt;Ideally you&amp;rsquo;ll ask questions related to Asterisk :)  I tend to specialize in queues and database integration, so those are the realms you&amp;rsquo;ll probably get the most indepth answer. Or if you just have a problem you&amp;rsquo;re trying to solve in dialplan that you can&amp;rsquo;t quite get to work, let me know, as I love creating clever dialplans.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Importing Master.csv into MySQL CDR table</title>
      <link>http://blog.leifmadsen.com/blog/2009/07/29/importing-master.csv-into-mysql-cdr-table/</link>
      <pubDate>Wed, 29 Jul 2009 12:49:51 +0000</pubDate>
      
      <guid>http://blog.leifmadsen.com/blog/2009/07/29/importing-master.csv-into-mysql-cdr-table/</guid>
      <description>&lt;blockquote&gt;
&lt;p&gt;Edit: I have updated the original post, which contained &amp;lsquo;custom&amp;rsquo; field name in the database instead of &amp;lsquo;userfield&amp;rsquo; which is a field Asterisk-Stat uses.
Edit2: Updated the field from &amp;lsquo;amaflag&amp;rsquo; to &amp;lsquo;amaflags&amp;rsquo; thanks to Justin.
Edit3: Updated the script based on feedback from Mads Peter Nielsen and Gabriel. Thanks!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Today I had a client that had a need to run some statistical analysis on their data, but since they didn&amp;rsquo;t have anything like that developed, I had to go on a search to find them something. After asking around on IRC (and pretty much knowing what the answer was already), I settled on installing the &lt;a href=&#34;http://www.areski.net/asterisk-stat-v2/about.php&#34;&gt;Areski asterisk-stat&lt;/a&gt; application.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Installing Asterisk-Stat is really quite straight forward, however, the installation documentation is not verbose. It says to modify the describe.php file, but doesn&amp;rsquo;t tell you where it is. After figuring that I needed to modify my own describe.php file in the root folder, I found that it exists in the lib/ subdirectory. Hope that helps someone._&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Since I had data in the Master.csv file (which is the file Asterisk writes its CDR data to by default), I just needed to import the data into a MySQL database (which I was doing because Asterisk-Stat doesn&amp;rsquo;t support reading in data from a flat-file), and run my newly installed Asterisk-Stat application.&lt;/p&gt;

&lt;p&gt;Instead of reinventing the wheel again, I figured I&amp;rsquo;d check out the various links on the &lt;a href=&#34;http://www.wired.com/culture/lifestyle/news/2004/08/64596&#34;&gt;internet&lt;/a&gt; for how to do it. This inevitably lead me to the &lt;a href=&#34;http://www.voip-info.org&#34;&gt;voip-info&lt;/a&gt; wiki, where lots of outdated, incomplete, misinformation exists. I will give credit that it gave me enough information (or links to information) to get what I needed done, but it required putting together a few pieces, and then modifying those pieces.&lt;/p&gt;

&lt;p&gt;OK, time to get off my soap box and give you what you really want. And really, I can&amp;rsquo;t yell at it too much &amp;ndash; I did eventually end up with what I needed!&lt;/p&gt;

&lt;p&gt;First, I copied the Master.csv from /var/log/asterisk/cdr-csv/ into a temporary working directory. This way I wasn&amp;rsquo;t messing around with the customers live data. Also note, this is a one time import, and will eventually need to move them over to writing their data to the database directly, but that is another article.&lt;/p&gt;

&lt;p&gt;So now that I have my working copy of Master.csv, it&amp;rsquo;s time to create the database, and import the data. I started by first installing the various applications I needed: httpd (apache), php, php-mysql, gd, and mysql-server. I then configured the database with a user login (so I didn&amp;rsquo;t need to modify as root), and created a database to put Asterisk related data into.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# mysql -u root -p
mysql&amp;gt; create database asterisk;
mysql&amp;gt; GRANT ALL PRIVILEGES ON asterisk.* TO &#39;asterisk&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;somemagicpassword&#39;;
mysql&amp;gt; flush privileges;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;OK awesome, I have now created my database, and have the &amp;lsquo;asterisk&amp;rsquo; user assigned to it. Now lets create our &amp;lsquo;cdr&amp;rsquo; table. Note that the following table description was taken from &lt;a href=&#34;http://www.voip-info.org/wiki/view/Asterisk+CDR+csv+conversion+mysql&#34;&gt;this page&lt;/a&gt;. It was the table description I found which contained the appropriate number of columns to match up with &lt;em&gt;my&lt;/em&gt; Master.csv file, and which the column names matched up with the data. Your mileage may vary based on Asterisk version (note I&amp;rsquo;m using a 1.4 based version of Asterisk). Run the following from the MySQL command prompt.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sql&#34;&gt;create table cdr (
       accountcode varchar (30),
       src varchar(64),
       dst varchar(64),
       dcontext varchar(32),
       clid varchar(32),
       channel varchar(32),
       dstchannel varchar(32),
       lastapp varchar(32),
       lastdata varchar(64),
       calldate timestamp NOT NULL,
       answerdate timestamp NOT NULL,
       hangupdate timestamp NOT NULL,
       duration int(8) unsigned default NULL,
       billsec int(8) unsigned default NULL,
       disposition varchar(32),
       amaflags varchar(128),
       uniqueid varchar(128),
       userfield varchar(128),
       PRIMARY KEY (clid,channel,calldate,uniqueid)
);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now that we have a table to import the data into, I had to find a script that would work. I found one originally, then realized it didn&amp;rsquo;t import the data as I needed it (oops, my bad for not looking carefully enough at the table structure), so I modified it to work with my table structure. The script was originally created by John Lange (thanks John!), and you can find it on &lt;a href=&#34;http://www.johnlange.ca/tech-tips/asterisk/asterisk-cdr-csv-mysql-import-v20/&#34;&gt;his blog&lt;/a&gt;. Find below my modified version of his script to work with the above mentioned CDR table layout.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;&amp;lt;?php
/*** process asterisk cdr file (Master.csv) insert usage
* values into a mysql database which is created for use
* with the Asterisk_addons cdr_addon_mysql.so
* The script will only insert NEW records so it is safe
* to run on the same log over-and-over.
*
* Author: John Lange (john@johnlange.ca)
* Date: Version 2 Released July 8, 2008
*
* Here is what the script does:
*
* Parse each row from the text log and insert it into the database after testing for a
* matching &amp;quot;calldate, src, duration&amp;quot; record in the database. Note that not all fields are
* tested.
*
* If you have a large existing database it is recommended that you add an index to the calldate
* field which will greatly speed up this import.
*
*/
/*
 * Modified by Leif Madsen, July 29, 2009 to add additional columns.
 * Original post and code by John Lange: http://www.johnlange.ca/tech-tips/asterisk/asterisk-cdr-csv-mysql-import-v20/
 */
$locale_db_host = &#39;localhost&#39;;
$locale_db_name = &#39;asterisk&#39;;
$locale_db_login = &#39;asterisk&#39;;
$locale_db_pass = &#39;somemagicpassword&#39;;
if($argc == 2) {
$logfile = $argv[1];
} else {
print(&amp;quot;Usage &amp;quot;.$argv[0].&amp;quot; &amp;lt;filename&amp;gt;\n&amp;quot;);
print(&amp;quot;Where filename is the path to the Asterisk csv file to import (Master.csv)\n&amp;quot;);
print(&amp;quot;This script is safe to run multiple times on a growing log file as it only imports records that are newer than the database\n&amp;quot;);
exit(0);
}
// connect to db
$linkmb = mysql_connect($locale_db_host, $locale_db_login, $locale_db_pass) or die(&amp;quot;Could not connect : &amp;quot; . mysql_error());
mysql_select_db($locale_db_name, $linkmb) or die(&amp;quot;Could not select database $locale_db_name&amp;quot;);
//** 1) Find records in the asterisk log file. **
$rows = 0;
$handle = fopen($logfile, &amp;quot;r&amp;quot;);
while (($data = fgetcsv($handle, 1000, &amp;quot;,&amp;quot;)) !== FALSE) {
// NOTE: the fields in Master.csv can vary. This should work by default on all installations but you may have to edit the next line to match your configuration
list($accountcode,$src, $dst, $dcontext, $clid, $channel, $dstchannel, $lastapp, $lastdata, $start, $answer, $end, $duration, $billsec, $disposition, $amaflags, $uniqueid, $userfield ) = $data;
/** 2) Test to see if the entry is unique **/
$sql=&amp;quot;SELECT calldate, src, duration&amp;quot;.
&amp;quot; FROM cdr&amp;quot;.
&amp;quot; WHERE calldate=&#39;$start&#39;&amp;quot;.
&amp;quot; AND src=&#39;$src&#39;&amp;quot;.
&amp;quot; AND duration=&#39;$duration&#39;&amp;quot;.
&amp;quot; LIMIT 1&amp;quot;;
if(!($result = mysql_query($sql, $linkmb))) {
print(&amp;quot;Invalid query: &amp;quot; . mysql_error().&amp;quot;\n&amp;quot;);
print(&amp;quot;SQL: $sql\n&amp;quot;);
die();
}
if(mysql_num_rows($result) == 0) { // we found a new record so add it to the DB
// 3) insert each row in the database
$sql = &amp;quot;INSERT INTO cdr (calldate, answerdate, hangupdate, clid, src, dst, dcontext, channel, dstchannel, lastapp, lastdata, duration, billsec, disposition, amaflags, accountcode, uniqueid, userfield) VALUES(&#39;$start&#39;, &#39;$answer&#39;, &#39;$end&#39;, &#39;&amp;quot;.mysql_real_escape_string($clid).&amp;quot;&#39;, &#39;$src&#39;, &#39;$dst&#39;, &#39;$dcontext&#39;, &#39;$channel&#39;, &#39;$dstchannel&#39;, &#39;$lastapp&#39;, &#39;$lastdata&#39;, &#39;$duration&#39;, &#39;$billsec&#39;, &#39;$disposition&#39;, &#39;$amaflags&#39;, &#39;$accountcode&#39;, &#39;$uniqueid&#39;, &#39;$userfield&#39;)&amp;quot;;
if(!($result2 = mysql_query($sql, $linkmb))) {
print(&amp;quot;Invalid query: &amp;quot; . mysql_error().&amp;quot;\n&amp;quot;);
print(&amp;quot;SQL: $sql\n&amp;quot;);
die();
}
print(&amp;quot;Inserted: $end $src $duration\n&amp;quot;);
$rows++;
} else {
print(&amp;quot;Not unique: $end $src $duration\n&amp;quot;);
}
}
fclose($handle);
print(&amp;quot;$rows imported\n&amp;quot;);
?&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now all that is left to do is import the data!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# php importcdr.php Master.csv
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
  </channel>
</rss>