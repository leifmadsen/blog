<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>AWX: The Poor Man&#39;s CI? &middot; Leif Madsen</title>

  
  <link rel="stylesheet" href="http://blog.leifmadsen.com/css/poole.css">
  <link rel="stylesheet" href="http://blog.leifmadsen.com/css/hyde.css">
  <link rel="stylesheet" href="http://blog.leifmadsen.com/css/poole-overrides.css">
  <link rel="stylesheet" href="http://blog.leifmadsen.com/css/hyde-overrides.css">
  <link rel="stylesheet" href="http://blog.leifmadsen.com/css/hyde-x.css">
  <link rel="stylesheet" href="http://blog.leifmadsen.com/css/highlight/monokai.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://blog.leifmadsen.com/touch-icon-144-precomposed.png">
  <link href="http://blog.leifmadsen.com/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="Leif Madsen&#39;s Blog">
  <meta name="keywords" content="ansible,awx,tower,CI,continous integration,DevOps,devops,testing,integation,majik">
  
</head>
<body>
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>Leif Madsen</h1>
      <p class="lead">I&rsquo;m not clever enough for a tagline.</p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="http://blog.leifmadsen.com/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="http://github.com/leifmadsen"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      <a href="http://linkedin.com/in/leifmadsen"><i class="fa fa-linkedin-square fa-3x"></i></a>
      
      
      <a href="http://twitter.com/leifmadsen"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      <a href="http://blog.leifmadsen.com/index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-3x"></i></a>
      </li>
    </ul>

    

    <p>Copyright &copy; 2017 <a href="http://blog.leifmadsen.com/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">AWX: The Poor Man&#39;s CI?</h1>
    <span class="post-date">Nov 7, 2017 &middot; 4 minute read &middot; <a href="http://blog.leifmadsen.com/blog/2017/11/07/awx-the-poor-mans-ci/#disqus_thread">Comments</a>
    
    <br/>
    <a class="label" href="http://blog.leifmadsen.com/categories/nfvpe">nfvpe</a><a class="label" href="http://blog.leifmadsen.com/categories/ansible">ansible</a><a class="label" href="http://blog.leifmadsen.com/categories/continuous-integration">continuous integration</a>
    </span>
    <p>



  





<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

I&rsquo;m just going to go ahead and blame <a href="https://twitter.com/dougbtv">@dougbtv</a>
for all my awesome and terrible ideas. We&rsquo;ve been working on several
<a href="https://github.com/ansible/ansible">Ansible</a> playbooks to spin up development
environments; like
<a href="https://github.com/redhat-nfvpe/kube-centos-ansible">kucean</a>.</p>

<p>Due to the rapid development nature of things like Kubernetes, Heketi,
GlusterFS, and other tools, it&rsquo;s both possible and probable that our playbooks
could become broken at any given time. We&rsquo;ve been wanting to get some continous
integration spun up to test this with something like <a href="https://docs.openstack.org/infra/zuul/feature/zuulv3/index.html">Zuul v3</a>
but the learning curve for something like that is a bit more than we&rsquo;d like to
tackle for some simple periodic runs. Same goes for <a href="https://jenkins.io/doc/">Jenkins</a>
or any other number of continous integration software bits.</p>

<p>Enter the brilliantly mad mind of @dougbtv. He wondered if AWX (Ansible Tower)
could be turned into a sort of &ldquo;Poor Man&rsquo;s CI&rdquo;? Hold my beer. Challenge
accepted!
</p>

<h2 id="get-awx-installed">Get AWX Installed</h2>

<p>The first thing we need to do is get AWX installed. Lucky for you, I already
wrote up a <a href="http://blog.leifmadsen.com/blog/2017/11/07/deploying-awx-to-openstack-rdo-cloud/">blog
post</a>
showing you how to consume some Ansible automation to get an OpenStack virtual
machine up and running and populated with the fiddly bits of AWX. There is also
the <a href="https://github.com/ansible/awx/blob/devel/INSTALL.md">upstream AWX installation guides</a>
that you can follow to get AWX up and running in your environment.</p>

<h2 id="so-what-are-we-trying-to-accomplish">So what are we trying to accomplish?</h2>

<p>First, let&rsquo;s step back and define what we&rsquo;re trying to do. The goal here is to
build something quick and dirty that would let us build configure some periodic
runs of our Ansible playbooks. Some of the nice to have bits would be:</p>

<ul>
<li>easily run our existing Ansible playbooks / Ansible native</li>
<li>run against some cloud infrastructure</li>
<li>continue to work against our local virtual, KVM-based development
environments</li>
<li>give some historical record of successful and failed runs</li>
<li>provide notifications to our Slack channel when things fail</li>
</ul>

<p>So what don&rsquo;t we want? Heavy infrastructure that we need to spend a lot of time
maintaining. Long setup times. Large amount of yak-shaving (overhead) to get
&ldquo;something&rdquo; up and going.</p>

<p>Because I was able to get AWX up and running in a short period of time through
automation (see previous section about getting AWX installed), it seemed like
AWX might fit the bill to fill in our complete lack of automation with
&ldquo;something&rdquo;.</p>

<h2 id="spoiler-alert">Spoiler alert!</h2>

<p>Turns out, AWX makes a pretty decent little periodic testing system when used
in conjunction with cloud infrastructure where your machines can be provisioned
and deprovisioned through Ansible playbooks, and then layering your
infrastructure deployment on top of that.</p>

<p>In our case, we wanted a twice-per-day deployment of
<a href="https://github.com/redhat-nfvpe/kube-centos-ansible">kucean</a> to run against
the RDO Cloud, and for a failure notification to pop into our Slack channel
when things stopped working.</p>

<p>I was able to build out just enough Ansible plays to make the whole thing work
out, and was pretty impressed with how clean some of the separation of
variables, facts, and other playbook specific data was. Notifications worked
swimmingly, and the Job Workflow stuff did exactly what I hoped.</p>

<p>Now that we know things weren&rsquo;t a complete disaster (much the opposite), you
know it&rsquo;s worth continuing to read on how we did it!</p>

<h2 id="building-a-minimal-ci-environment">Building a minimal CI environment</h2>

<p>Our minimal CI environment will be entirely deployed into an OpenStack cloud,
where AWX will run, and will also have access to deploying virtual machines in
the same cloud for our jobs (although it could easily be another cloud
environment, project, etc).</p>

<p>
<link rel="stylesheet" href="http://blog.leifmadsen.com/css/hugo-easy-gallery.css" />
<div class="box fancy-figure caption-position-bottom" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="http://blog.leifmadsen.com/media/awx-ci-topology.png" alt="Basic AWX CI Topology"/>
    </div>
    <a href="http://blog.leifmadsen.com/media/awx-ci-topology.png" itemprop="contentUrl"></a>
  </figure>
</div>
</p>

<p>Our AWX environment will make use of my
<a href="https://github.com/leifmadsen/openstack-inventory-builder">openstack-inventory-builder</a>
playbook which does the heavy lifting of creating our OpenStack virtual
machines via a variable list. By using the playbook, we can create a job
template for the provisioning and deprovisioning of the virtual machines that
are agnostic to our deployment.</p>

<p>In the following sections I&rsquo;ll show you how I setup AWX to periodically
deprovision a set of virtual machine, reinstantiate them, run
<a href="https://github.com/redhat-nfvpe/kube-centos-ansible">kucean</a> against them to
get a Kubernetes environment running, and report back to our Slack channel via
notifications.</p>

<h3 id="creating-the-projects">Creating the projects</h3>

<p>In AWX, a project is an SCM (source control management) object that contains
the Ansible playbooks you want to use in a job template. For our configuration
we&rsquo;ll be setting up two projects;
<a href="https://github.com/leifmadsen/openstack-inventory-builder">openstack-inventory-builder</a>
and <a href="https://github.com/redhat-nfvpe/kube-centos-ansible">kucean</a>.</p>

<p>To create these projects, we need to click on the Projects tab and click Add.
We then need to fill in the fields like in the screenshot below.</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="http://blog.leifmadsen.com/media/awx-ci/project-configuration.png" alt="Project configuration in AWX"/>
    </div>
    <a href="http://blog.leifmadsen.com/media/awx-ci/project-configuration.png" itemprop="contentUrl"></a>
  </figure>
</div>


<h3 id="creating-credentials">Creating credentials</h3>

<h3 id="creating-inventories">Creating inventories</h3>

<h3 id="creating-inventory-sources">Creating inventory sources</h3>

<h3 id="creating-job-templates">Creating job templates</h3>

<h3 id="creating-a-job-workflow">Creating a job workflow</h3>

<h3 id="setting-up-a-slack-notification">Setting up a Slack notification</h3>
  </div>
  <div id="disqus_thread"></div>
</div>

<script type="text/javascript">
(function() {
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'leifmadsen';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-84933598-1', 'auto');
ga('send', 'pageview');
</script>


<script src="http://blog.leifmadsen.com/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="http://blog.leifmadsen.com/js/load-photoswipe.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>

</body>
</html>

